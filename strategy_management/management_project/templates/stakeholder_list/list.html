{% extends "dashboard.html" %}
{% load humanize %}
{% block content %}

<div class="container-fluid" id="stakeholder-container">
    <!-- Display Messages -->
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}

    <!-- Actions -->
    <div class="row mb-3">
        <div class="col-md-6">
            <a href="{% url 'create_stakeholder' %}"
               class="btn btn-primary"
               hx-get="{% url 'create_stakeholder' %}"
               hx-trigger="click"
               hx-target="#full-page-container"
               hx-swap="innerHTML"
               hx-push-url="true">
                Create Stakeholder
            </a>
            <a href="{% url 'export_stakeholders_to_excel' %}" class="btn btn-success">Export to Excel</a>
        </div>
        <div class="col-md-6">
            <form method="get"
                  action="{% url 'stakeholder_list' %}"
                  class="d-flex justify-content-end"
                  hx-get="{% url 'stakeholder_list' %}"
                  hx-target="#full-page-container"
                  hx-trigger="keyup changed delay:800ms from:input[name='search']">
                <input type="text"
                       name="search"
                       class="form-control me-2"
                       placeholder="Search stakeholders..."
                       value="{{ search_query|default_if_none:'' }}">
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
        </div>
    </div>

    <!-- Stakeholders Table -->
    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-bordered table-striped table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Organization</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Impact</th>
                    <th>Interest</th>
                    <th>Engagement Strategy</th>
                    <th>Influence Score</th>
                    <th>Priority</th>
                    <th>Satisfaction</th>
                    <th>Risk</th>
                    <th>Contribution</th>
                    <th>Contact</th>
                    <th>Description</th>
                    <th>Notes</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for stakeholder in page_obj %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ stakeholder.organization_name }}</td>
                        <td>
                            <a hx-get="{% url 'update_stakeholder' stakeholder.pk %}"
                               hx-trigger="click"
                               hx-target="#full-page-container"
                               hx-swap="innerHTML"
                               href="{% url 'update_stakeholder' stakeholder.pk %}"
                               hx-push-url="true">
                                {{ stakeholder.stakeholder_name }}
                            </a>
                        </td>
                        <td>{{ stakeholder.get_stakeholder_type_display }}</td>
                        <td>{{ stakeholder.get_role_display }}</td>
                        <td>{{ stakeholder.department|default:"-" }}</td>
                        <td>{{ stakeholder.get_impact_level_display }}</td>
                        <td>{{ stakeholder.get_interest_level_display }}</td>
                        <td>{{ stakeholder.get_engagement_strategy_display }}</td>
                        <td>{{ stakeholder.influence_score|floatformat:2 }}</td>
                        <td>{{ stakeholder.get_priority_display }}</td>
                        <td>{{ stakeholder.get_satisfaction_level_display }}</td>
                        <td>{{ stakeholder.get_risk_level_display }}</td>
                        <td>{{ stakeholder.get_contribution_score_display }}</td>
                        <td>{{ stakeholder.contact_info|default:"-" }}</td>
                        <td>{{ stakeholder.description|default:"-" }}</td>
                        <td>{{ stakeholder.notes|default:"-" }}</td>
                        <td>
                            <a class="btn btn-warning btn-sm"
                               hx-get="{% url 'update_stakeholder' stakeholder.pk %}"
                               hx-trigger="click"
                               hx-target="#full-page-container"
                               hx-swap="innerHTML"
                               hx-push-url="true">
                                Update
                            </a>
                        </td>
                        <td>
                            <a class="btn btn-danger btn-sm"
                               hx-get="{% url 'delete_stakeholder' stakeholder.pk %}"
                               hx-trigger="click"
                               hx-target="#full-page-container"
                               hx-swap="innerHTML"
                               hx-push-url="true">
                                Delete
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-3">
        {% include 'pagination.html' %}
    </div>

    <!-- Quick Summary by Role -->
    <div id="role-count" class="mt-5">
        <h5>Stakeholders by Role</h5>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Role</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in count_by_role %}
                    <tr>
                        <td>{{ entry.role }}</td>
                        <td>{{ entry.role_count }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <td>Total Stakeholders</td>
                    <td>{{ total_stakeholders }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Quick Summary by Position (Department) -->
    <div id="position-count" class="mt-5">
        <h5>Stakeholders by Department</h5>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in count_by_department %}
                    <tr>
                        <td>{{ entry.department|default:"(Not Assigned)" }}</td>
                        <td>{{ entry.department_count }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock content %}
