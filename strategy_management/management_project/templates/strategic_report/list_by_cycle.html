{% extends "dashboard.html" %}
{% load humanize %}
{% block content %}

<div class="d-flex justify-content-between flex-wrap mb-3 gap-2">
    <!-- Back Button -->
    <a class="btn btn-danger"
       href="{% url 'strategy_report_by_cycle_list' %}"
       hx-get="{% url 'strategy_report_by_cycle_list' %}"
       hx-target="#full-page-container"
       hx-swap="innerHTML"
       hx-push-url="true">
        <i class="bi bi-arrow-left"></i> Back to Strategic Report Cycles
    </a>
</div>

<!-- Page Header -->
<div class="d-flex flex-column flex-md-row flex-wrap align-items-md-center justify-content-between mb-4 gap-3">

    <!-- Left: Title -->
    <div class="me-md-3">
        <h2 class="mb-0">Strategic Report Records</h2>
        <h5 class="text-muted mb-0">{{ strategy_by_cycle.name }}</h5>
    </div>

    <!-- Middle: Search -->
    <form method="get"
          action="{% url 'strategic_report_list' strategy_by_cycle.slug %}"
          class="d-flex flex-grow-1 mx-md-3"
          hx-get="{% url 'strategic_report_list' strategy_by_cycle.slug %}"
          hx-target="#full-page-container"
          hx-trigger="keyup changed delay:500ms from:input[name='search']">
        <div class="input-group w-100">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" name="search"
                   class="form-control"
                   placeholder="Search by Perspective, Pillar, Objective, KPI, Responsible Body..."
                   value="{{ search_query|default_if_none:'' }}">
        </div>
    </form>

    <!-- Right: Buttons -->
    <div class="d-flex flex-wrap align-items-center gap-2 mt-2 mt-md-0">
        <a class="btn btn-success"
           href="{% url 'export_strategic_reports' strategy_by_cycle.slug %}">
            <i class="bi bi-file-earmark-excel"></i> Export
        </a>
        <a class="btn btn-primary"
           href="{% url 'create_strategic_report' strategy_by_cycle.slug %}"
           hx-get="{% url 'create_strategic_report' strategy_by_cycle.slug %}"
           hx-target="#full-page-container"
           hx-swap="innerHTML"
           hx-push-url="true">
            <i class="bi bi-plus-circle"></i> Create Report
        </a>
    </div>
</div>

<!-- Data Table -->
<div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Reports</h5>
        <span class="badge bg-primary">{{ page_obj.paginator.count }} records</span>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm">
            <thead class="table-light sticky-top">
            <tr>
                <th>#</th>
                <th>Perspective</th>
                <th>Pillar</th>
                <th>Objective</th>
                <th>KPI</th>
                <th>Baseline</th>
                <th>Target</th>
                <th>Achievement</th>
                <th>% Achieved</th>
                <th>Variance</th>
                <th>Weighted Score</th>
                <th>Responsible</th>
                <th>Status</th>
                <th>Updated</th>
                <th class="text-center">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for report in page_obj %}
            <tr>
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td>{{ report.action_plan.strategy_map.strategic_perspective|truncatewords:3 }}</td>
                <td>{{ report.action_plan.strategy_map.strategic_pillar|truncatewords:3 }}</td>
                <td>{{ report.action_plan.strategy_map.objective|truncatewords:4 }}</td>
                <td>{{ report.action_plan.strategy_map.kpi|truncatewords:4 }}</td>
                <td class="text-end">{{ report.action_plan.baseline|floatformat:2|intcomma }}</td>
                <td class="text-end">{{ report.action_plan.target|floatformat:2|intcomma }}</td>
                <td class="text-end fw-semibold">{{ report.achievement|floatformat:2|intcomma }}</td>
                <td class="text-end">
                    {% if report.percent_achieved >= 100 %}
                        <span class="badge bg-success">{{ report.percent_achieved|floatformat:0 }}%</span>
                    {% elif report.percent_achieved >= 75 %}
                        <span class="badge bg-primary">{{ report.percent_achieved|floatformat:0 }}%</span>
                    {% elif report.percent_achieved >= 50 %}
                        <span class="badge bg-warning">{{ report.percent_achieved|floatformat:0 }}%</span>
                    {% else %}
                        <span class="badge bg-danger">{{ report.percent_achieved|floatformat:0 }}%</span>
                    {% endif %}
                </td>
                <td class="text-end">
                    {% if report.variance > 0 %}
                        <span class="text-success">+{{ report.variance|floatformat:2|intcomma }}</span>
                    {% else %}
                        <span class="text-danger">{{ report.variance|floatformat:2|intcomma }}</span>
                    {% endif %}
                </td>
                <td class="text-end fw-semibold">{{ report.weighted_score|floatformat:2|intcomma }}</td>
                <td>{{ report.action_plan.responsible_bodies_display|truncatewords:3 }}</td>
                <td>
                    {% if report.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                    {% elif report.status == 'on_track' %}
                        <span class="badge bg-primary">On Track</span>
                    {% elif report.status == 'delayed' %}
                        <span class="badge bg-warning">Delayed</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ report.status|default:"Pending" }}</span>
                    {% endif %}
                </td>
                <td nowrap>{{ report.updated_at|date:"M d, Y" }}</td>
                <td class="text-center" nowrap>
                    <div class="btn-group btn-group-sm" role="group">
                        <a class="btn btn-info"
                           href="{% url 'strategic_report_detail' strategy_by_cycle.slug report.pk %}"
                           hx-get="{% url 'strategic_report_detail' strategy_by_cycle.slug report.pk %}"
                           hx-target="#full-page-container"
                           hx-swap="innerHTML"
                           data-bs-toggle="tooltip" title="View Details">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a class="btn btn-warning"
                           href="{% url 'update_strategic_report' strategy_by_cycle.slug report.pk %}"
                           hx-get="{% url 'update_strategic_report' strategy_by_cycle.slug report.pk %}"
                           hx-target="#full-page-container"
                           hx-swap="innerHTML"
                           hx-push-url="true"
                           data-bs-toggle="tooltip" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a class="btn btn-danger"
                           href="{% url 'delete_strategic_report' strategy_by_cycle.slug report.pk %}"
                           hx-get="{% url 'delete_strategic_report' strategy_by_cycle.slug report.pk %}"
                           hx-target="#full-page-container"
                           hx-swap="innerHTML"
                           hx-push-url="true"
                           data-bs-toggle="tooltip" title="Delete">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="15" class="text-center py-4">
                    <div class="text-muted">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">No Strategic Reports found.</p>
                        <a class="btn btn-primary mt-2"
                           href="{% url 'create_strategic_report' strategy_by_cycle.slug %}"
                           hx-get="{% url 'create_strategic_report' strategy_by_cycle.slug %}"
                           hx-target="#full-page-container"
                           hx-swap="innerHTML"
                           hx-push-url="true">
                            Create your first report
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="card-footer">
        <div id="pagination">
            {% include 'pagination.html' %}
        </div>
    </div>
</div>

<style>
.sticky-top { position: sticky; top: 0; z-index: 10; }
.table th { white-space: nowrap; }
.table-responsive { max-height: 70vh; overflow: auto; }
</style>

<script>
// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
});
</script>

{% endblock %}
