{% extends "dashboard.html" %}
{% load humanize %}
{% block content %}
<div class="container-fluid mt-4">

    <!-- Flash messages -->
    {% for message in messages %}
    <p class="text-danger my-1">{{ message }}</p>
    {% endfor %}

    <!-- Header and Actions -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">

        <!-- Create Report -->
        <a href="{% url 'create_strategic_report' %}" class="btn btn-success"
           hx-get="{% url 'create_strategic_report' %}"
           hx-trigger="click"
           hx-target="#full-page-container"
           hx-swap="innerHTML"
           hx-push-url="true"
        >
            ‚ûï Create Strategic Report
        </a>

        <h2 class="fs-5 flex-grow-1 text-center text-md-start mb-0">Strategic Report List</h2>

        <!-- Export -->
        <a href="{% url 'export_strategic_report_to_excel'%}"
           class="btn btn-success"
           hx-get="{% url 'export_strategic_report_to_excel' %}"
           hx-trigger="click"
           hx-target="_blank"
           hx-swap="none">
            üì• Export to Excel
        </a>
    </div>

    <!-- Filter and Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get"
                  action="{% url 'strategic_report_list' %}"
                  hx-get="{% url 'strategic_report_list' %}"
                  hx-target="#full-page-container"
                  hx-trigger="change from:select, keyup changed delay:800ms from:input[name='search']">

                <div class="row g-3">
                    <!-- Search Input -->
                    <div class="col-md-4">
                        <label for="search" class="form-label">Search</label>
                        <input type="text"
                               name="search"
                               id="search"
                               class="form-control"
                               placeholder="Search by KPI, objective, responsible body..."
                               value="{{ search_query|default_if_none:'' }}">
                    </div>

                    <!-- Responsible Body Dropdown -->
                    <div class="col-md-3">
                        <label for="responsible_body" class="form-label">Responsible Body</label>
                        <select name="responsible_body" id="responsible_body" class="form-select">
                            <option value="">All Responsible Bodies</option>
                            {% for body in responsible_bodies %}
                                <option value="{{ body }}" {% if body == selected_responsible_body %}selected{% endif %}>
                                    {{ body }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Strategic Cycle Dropdown -->
                    <div class="col-md-3">
                        <label for="strategic_cycle" class="form-label">Strategic Cycle</label>
                        <select name="strategic_cycle" id="strategic_cycle" class="form-select">
                            <option value="">All Strategic Cycles</option>
                            {% for cycle in strategic_cycles %}
                                <option value="{{ cycle }}" {% if cycle == selected_strategic_cycle %}selected{% endif %}>
                                    {{ cycle }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Reset Button -->
                    <div class="col-md-2 d-flex align-items-end">
                        <a href="{% url 'strategic_report_list' %}" class="btn btn-secondary w-100">Reset Filters</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm">
            <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Time Horizon</th>
                <th>Time Horizon Type</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>KPI</th>
                <th>Baseline</th>
                <th>Target</th>
                <th>Achievement</th>
                <th>Percent Achieved</th>
                <th>Variance</th>
                <th>Weighted Score</th>
                <th>Responsible Body</th>
                <th>Data Source</th>
                <th>Data Collector</th>
                <th>Progress Summary</th>
                <th>Performance Summary</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Updated At</th>
                <th>Update</th>
                <th>Delete</th>
            </tr>
            </thead>
            <tbody>
            {% for report in page_obj %}
            <tr>
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td>{{ report.action_plan.strategic_cycle.time_horizon }}</td>
                <td>{{ report.action_plan.strategic_cycle.time_horizon_type }}</td>
                <td>{{ report.action_plan.strategic_cycle.start_date }}</td>
                <td>{{ report.action_plan.strategic_cycle.end_date }}</td>
                <td>{{ report.action_plan.key_performance_indicator }}</td>
                <td>{{ report.action_plan.baseline|floatformat:2|intcomma }}</td>
                <td>{{ report.action_plan.target|floatformat:2|intcomma }}</td>
                <td>{{ report.achievement|floatformat:2|intcomma }}</td>
                <td>{{ report.percent_achieved|floatformat:2 }}%</td>
                <td>{{ report.variance|floatformat:2|intcomma }}</td>
                <td>{{ report.weighted_score|floatformat:2|intcomma }}</td>
                <td>{{ report.action_plan.responsible_bodies_display }}</td>
                <td>{{ report.data_source }}</td>
                <td>{{ report.data_collector }}</td>
                <td>{{ report.progress_summary|default:"-" }}</td>
                <td>{{ report.performance_summary|default:"-" }}</td>
                <td>{{ report.status }}</td>
                <td>{{ report.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ report.updated_at|date:"Y-m-d H:i" }}</td>
                <td>
                    <a href="{% url 'update_strategic_report' report.pk %}"
                       class="btn btn-warning btn-sm"
                       hx-get="{% url 'update_strategic_report' report.pk %}"
                       hx-trigger="click"
                       hx-target="#full-page-container"
                       hx-swap="innerHTML"
                       hx-push-url="true">
                        ‚úèÔ∏è
                    </a>
                </td>
                <td>
                    <a href="{% url 'delete_strategic_report' report.pk %}"
                       class="btn btn-danger btn-sm"
                       hx-get="{% url 'delete_strategic_report' report.pk %}"
                       hx-trigger="click"
                       hx-target="#full-page-container"
                       hx-swap="innerHTML"
                       hx-push-url="true">
                        üóëÔ∏è
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="22" class="text-center">No strategic reports found.</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination">
        {% include 'pagination.html' %}
    </div>

</div>
{% endblock %}