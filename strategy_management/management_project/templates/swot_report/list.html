{% extends "dashboard.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid" id="full-page-container">
    <!-- Display Messages -->
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    <!-- Header: Create & Filters -->
    <div class="row mb-3 align-items-center">
        <div class="col-md-6">
            <a href="{% url 'create_swot_report' %}"
               class="btn btn-primary"
               hx-get="{% url 'create_swot_report' %}"
               hx-target="#full-page-container"
               hx-swap="innerHTML"
               hx-push-url="true">
                Create SWOT Report
            </a>
        </div>

        <div class="col-md-6">
            <form method="get"
                  action="{% url 'swot_report_list' %}"
                  class="d-flex gap-2 justify-content-end"
                  hx-get="{% url 'swot_report_list' %}"
                  hx-target="#full-page-container"
                  hx-trigger="change from:select, keyup changed delay:800ms from:input[name='search']">
                
                <!-- Strategic Cycle Filter -->
                <select name="cycle" class="form-select" style="max-width: 200px;">
                    <option value="">All Strategic Cycles</option>
                    {% for cycle in strategic_cycles %}
                        <option value="{{ cycle.slug }}" 
                            {% if cycle.slug == selected_cycle %}selected{% endif %}>
                            {{ cycle.name }} ({{ cycle.start_date|date:"M Y" }} - {{ cycle.end_date|date:"M Y" }})
                        </option>
                    {% endfor %}
                </select>
                
                <!-- Search -->
                <input type="text"
                       name="search"
                       class="form-control"
                       placeholder="Search SWOT..."
                       value="{{ search_query|default_if_none:'' }}"
                       style="max-width: 200px;">
                
                <button type="submit" class="btn btn-primary">Apply</button>
                
                <!-- Clear Filters -->
                {% if selected_cycle or search_query %}
                    <a href="{% url 'swot_report_list' %}" 
                       class="btn btn-outline-secondary"
                       hx-get="{% url 'swot_report_list' %}"
                       hx-target="#full-page-container"
                       hx-swap="innerHTML">
                        Clear
                    </a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Filter Summary -->
    {% if selected_cycle %}
        <div class="alert alert-info mb-3">
            <strong>Filtered by:</strong> 
            {% for cycle in strategic_cycles %}
                {% if cycle.slug == selected_cycle %}
                    {{ cycle.name }} ({{ cycle.start_date|date:"M Y" }} - {{ cycle.end_date|date:"M Y" }})
                {% endif %}
            {% endfor %}
            {% if search_query %}
                | Search: "{{ search_query }}"
            {% endif %}
        </div>
    {% endif %}

    <!-- SWOT Table -->
    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-bordered table-striped table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Strategic Cycle</th>
                    <th>SWOT Type</th>
                    <th>Pillar</th>
                    <th>Factor</th>
                    <th>Description</th>
                    <th>Priority</th>
                    <th>Impact</th>
                    <th>Likelihood</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for s in swots %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <small>
                                {{ s.strategic_report_period.action_plan.strategic_cycle.name }}<br>
                                <span class="text-muted">
                                    {{ s.strategic_report_period.action_plan.strategic_cycle.start_date|date:"M Y" }} - 
                                    {{ s.strategic_report_period.action_plan.strategic_cycle.end_date|date:"M Y" }}
                                </span>
                            </small>
                        </td>
                        <td>
                            <span class="badge 
                                {% if s.swot_type == 'Strength' %}bg-success
                                {% elif s.swot_type == 'Weakness' %}bg-danger
                                {% elif s.swot_type == 'Opportunity' %}bg-warning
                                {% else %}bg-secondary{% endif %}">
                                {{ s.swot_type }}
                            </span>
                        </td>
                        <td>{{ s.swot_pillar }}</td>
                        <td>{{ s.swot_factor }}</td>
                        <td>
                            {% if s.description %}
                                <span title="{{ s.description }}">
                                    {{ s.description|truncatewords:10 }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge 
                                {% if s.priority == 'High' %}bg-danger
                                {% elif s.priority == 'Medium' %}bg-warning
                                {% else %}bg-info{% endif %}">
                                {{ s.priority }}
                            </span>
                        </td>
                        <td>
                            <span class="badge 
                                {% if s.impact == 'High' %}bg-danger
                                {% elif s.impact == 'Medium' %}bg-warning
                                {% else %}bg-info{% endif %}">
                                {{ s.impact }}
                            </span>
                        </td>
                        <td>
                            {% if s.likelihood %}
                                <span class="badge 
                                    {% if s.likelihood == 'High' %}bg-danger
                                    {% elif s.likelihood == 'Medium' %}bg-warning
                                    {% else %}bg-info{% endif %}">
                                    {{ s.likelihood }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ s.created_at|date:"M d, Y" }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a class="btn btn-outline-warning"
                                   hx-get="{% url 'update_swot_report' s.pk %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   hx-push-url="true"
                                   title="Edit">
                                    ‚úèÔ∏è
                                </a>
                                <a class="btn btn-outline-danger"
                                   hx-get="{% url 'delete_swot_report' s.pk %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   hx-push-url="true"
                                   title="Delete">
                                    üóëÔ∏è
                                </a>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-4">
                            {% if selected_cycle or search_query %}
                                No SWOT entries found matching your filters.
                                <a href="{% url 'swot_report_list' %}"
                                   hx-get="{% url 'swot_report_list' %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   class="btn btn-sm btn-outline-primary mt-2">
                                    Clear filters
                                </a>
                            {% else %}
                                No SWOT entries found. 
                                <a href="{% url 'create_swot_report' %}"
                                   hx-get="{% url 'create_swot_report' %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   hx-push-url="true"
                                   class="btn btn-sm btn-primary mt-2">
                                    Create your first SWOT report
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Results Count -->
    <div class="mt-3 text-muted">
        Showing {{ swots|length }} SWOT report{{ swots|length|pluralize }}
    </div>
</div>

<style>
    .badge {
        font-size: 0.75em;
    }
    .table td {
        vertical-align: middle;
    }
    .btn-group {
        white-space: nowrap;
    }
</style>
{% endblock content %}