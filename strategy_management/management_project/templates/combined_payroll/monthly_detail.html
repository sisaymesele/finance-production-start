{% extends "dashboard.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid my-4">

    <!-- Page Header -->
    <div class="row align-items-center mb-2 g-3">
        <div class="col-12 col-lg-4 text-center text-lg-start">
            <h3 class="mb-0">Combined Monthly Payroll Detail</h3>
        </div>

        <!-- Export Button -->
        <div class="col-12 col-lg-4 text-center text-lg-end">
            <a href="{% url 'export_combined_monthly_detail_to_excel' %}" class="btn btn-success w-100 w-lg-auto">
                <i class="bi bi-file-earmark-excel-fill me-1"></i> Export to Excel
            </a>
        </div>
    </div>

    {% if page_obj %}
    {% for month in page_obj %}
    <!-- Payroll Card -->
    <div class="card shadow-sm mb-5 border-primary mx-auto" style="max-width: 1160px;"
         id="combined_monthly_detail_{{ forloop.counter }}">
        <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
            Combined Monthly Payroll Detail for {{ month.month }}

            <!-- Collapse toggle button -->
            <button class="btn btn-sm btn-light" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse_{{ forloop.counter }}"
                    aria-expanded="true"
                    aria-controls="collapse_{{ forloop.counter }}">
                <i class="bi bi-caret-down-fill"></i>
            </button>
        </div>

        <div id="collapse_{{ forloop.counter }}" class="collapse show">
            <div class="card-body px-4">
                <div class="row g-4">
                    <!-- LEFT COLUMN (Main Content) -->
                    <div class="col-md-8 pe-md-4">
                        <!-- REGULAR PAYROLL SECTION -->
                        <div class="mb-2">
                            <h5 class="text-success border-bottom pb-2 mb-3">Strategic Action Plan</h5>

                            <!-- Regular Components -->
                            <div class="table-responsive mb-2">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, amount in month.regular_item_by_component.items %}
                                            {% if amount %}
                                            <tr>
                                                <td>{{ comp }}</td>
                                                <td class="text-end">{{ amount|floatformat:2|intcomma }}</td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Regular Summary -->
                            <h5>Regular Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if month.regular.taxable_gross %}<tr><td>Taxable Gross</td><td class="text-end">{{ month.regular.taxable_gross|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.regular.non_taxable_gross %}<tr><td>Non-Taxable Gross</td><td class="text-end">{{ month.regular.non_taxable_gross|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        <tr class="table-primary"><td><strong>Gross Pay</strong></td><td class="text-end"><strong>{{ month.regular.gross|floatformat:2|intcomma }}</strong></td></tr>
                                        {% if month.regular.pensionable %}<tr><td>Pensionable Amount</td><td class="text-end">{{ month.regular.pensionable|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.regular.employee_pension %}<tr><td>Employee Pension</td><td class="text-end">{{ month.regular.employee_pension|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.regular.employer_pension %}<tr><td>Employer Pension</td><td class="text-end">{{ month.regular.employer_pension|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.regular.total_pension %}<tr><td>Total Pension</td><td class="text-end">{{ month.regular.total_pension|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.regular.employment_income_tax %}<tr><td>Employment Income Tax</td><td class="text-end">{{ month.regular.employment_income_tax|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.regular.total_regular_deduction %}<tr><td>Total Regular Deduction</td><td class="text-end">{{ month.regular.total_regular_deduction|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        <tr class="table-success"><td><strong>Net Pay</strong></td><td class="text-end"><strong>{{ month.regular.net_pay|floatformat:2|intcomma }}</strong></td></tr>
                                        {% if month.regular.expense %}<tr><td>Expense</td><td class="text-end">{{ month.regular.expense|floatformat:2|intcomma }}</td></tr>{% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- EARNING ADJUSTMENTS SECTION -->
                        {% if month.show_earning %}
                        <div class="mb-2">
                            <h5 class="text-warning border-bottom pb-2 mb-3">Strategic Reports</h5>

                            <!-- Earning Components -->
                            <div class="table-responsive mb-2">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Earning Amount</th>
                                            <th class="text-end">Taxable</th>
                                            <th class="text-end">Non-Taxable</th>
                                            <th class="text-end">Employee Pension</th>
                                            <th class="text-end">Employer Pension</th>
                                            <th class="text-end">Total Pension</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, vals in month.earning_adj_by_component.items %}
                                            {% with earning=vals.earning_amount|default_if_none:0|add:0 %}
                                            {% with taxable=vals.taxable|default_if_none:0|add:0 %}
                                            {% with non_taxable=vals.non_taxable|default_if_none:0|add:0 %}
                                            {% with emp_pension=vals.employee_pension_contribution|default_if_none:0|add:0 %}
                                            {% with er_pension=vals.employer_pension_contribution|default_if_none:0|add:0 %}
                                            {% with total_pension=vals.total_pension|default_if_none:0|add:0 %}

                                            {% if earning != 0 or taxable != 0 or non_taxable != 0 or emp_pension != 0 or er_pension != 0 or total_pension != 0 %}
                                            <tr>
                                                <td>{{ comp }}</td>
                                                <td class="text-end">{{ vals.earning_amount|floatformat:2|intcomma }}</td>
                                                <td class="text-end">{{ vals.taxable|floatformat:2|intcomma }}</td>
                                                <td class="text-end">{{ vals.non_taxable|floatformat:2|intcomma }}</td>
                                                <td class="text-end">{{ vals.employee_pension_contribution|floatformat:2|intcomma }}</td>
                                                <td class="text-end">{{ vals.employer_pension_contribution|floatformat:2|intcomma }}</td>
                                                <td class="text-end">{{ vals.total_pension|floatformat:2|intcomma }}</td>
                                            </tr>
                                            {% endif %}

                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Strategic Report Summary -->
                            <h5>Strategic Report Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% with adj=month.adjustment %}
                                            {% if adj.taxable_gross|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Taxable Gross</td><td class="text-end">{{ adj.taxable_gross|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.non_taxable_gross|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Non-Taxable Gross</td><td class="text-end">{{ adj.non_taxable_gross|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.gross|default_if_none:0|add:0 != 0 %}
                                                <tr class="table-primary"><td><strong>Gross Adjustment</strong></td><td class="text-end"><strong>{{ adj.gross|floatformat:2|intcomma }}</strong></td></tr>
                                            {% endif %}
                                            {% if adj.adjusted_pensionable|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Adjusted Pensionable</td><td class="text-end">{{ adj.adjusted_pensionable|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.employee_pension|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Employee Pension</td><td class="text-end">{{ adj.employee_pension|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.employer_pension|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Employer Pension</td><td class="text-end">{{ adj.employer_pension|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.total_pension|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Total Pension</td><td class="text-end">{{ adj.total_pension|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.employment_income_tax|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Employment Income Tax</td><td class="text-end">{{ adj.employment_income_tax|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.strategic_report_deduction|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Strategic Report Deduction</td><td class="text-end">{{ adj.strategic_report_deduction|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.expense|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Expense</td><td class="text-end">{{ adj.expense|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                        {% endwith %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- DEDUCTION ADJUSTMENTS SECTION -->
                        {% if month.show_deduction %}
                        <div class="mb-2">
                            <h5 class="text-danger border-bottom pb-2 mb-3">Deduction Adjustments</h5>

                            <!-- Deduction Components -->
                            <div class="table-responsive mb-2">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-danger">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp, amount in month.deduction_adj_by_component.items %}
                                        {% if amount %}
                                        <tr>
                                            <td>{{ comp }}</td>
                                            <td class="text-end">{{ amount|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Deduction Summary -->
                            <h5>Deduction Adjustment Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-danger">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if month.adjustment.individual_adjustment_deduction|default_if_none:0|add:0 != 0 %}
                                        <tr>
                                            <td>Individual Adjustment Deduction</td>
                                            <td class="text-end">{{ month.adjustment.individual_adjustment_deduction|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- ADJUSTMENT SUMMARY SECTION -->
                        {% if month.show_earning or month.show_deduction %}
                        <div class="mb-2">
                            <h5 class="text-info border-bottom pb-2 mb-3">Adjustment Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-info">
                                        <tr>
                                            <th>Summary Item</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% with adj=month.adjustment %}
                                            {% if adj.taxable_gross|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Taxable Gross</td><td class="text-end">{{ adj.taxable_gross|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.non_taxable_gross|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Non-Taxable Gross</td><td class="text-end">{{ adj.non_taxable_gross|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.gross|default_if_none:0|add:0 != 0 %}
                                                <tr class="table-primary"><td><strong>Gross Adjustment</strong></td><td class="text-end"><strong>{{ adj.gross|floatformat:2|intcomma }}</strong></td></tr>
                                            {% endif %}
                                            {% if adj.adjusted_pensionable|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Adjusted Pensionable</td><td class="text-end">{{ adj.adjusted_pensionable|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.employee_pension|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Employee Pension</td><td class="text-end">{{ adj.employee_pension|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.employer_pension|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Employer Pension</td><td class="text-end">{{ adj.employer_pension|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.total_pension|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Total Pension</td><td class="text-end">{{ adj.total_pension|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.employment_income_tax|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Employment Income Tax</td><td class="text-end">{{ adj.employment_income_tax|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.strategic_report_deduction|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Strategic Report Deduction</td><td class="text-end">{{ adj.strategic_report_deduction|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.individual_adjustment_deduction|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Individual Adjustment Deduction</td><td class="text-end">{{ adj.individual_adjustment_deduction|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                            {% if adj.total_monthly_adjustment_deduction|default_if_none:0|add:0 != 0 %}
                                                <tr class="table-primary"><td><strong>Total Monthly Adjustment Deduction</strong></td><td class="text-end"><strong>{{ adj.total_monthly_adjustment_deduction|floatformat:2|intcomma }}</strong></td></tr>
                                            {% endif %}
                                            {% if adj.net_monthly_adjustment|default_if_none:0|add:0 != 0 %}
                                                <tr class="table-success"><td><strong>Net Monthly Adjustment</strong></td><td class="text-end"><strong>{{ adj.net_monthly_adjustment|floatformat:2|intcomma }}</strong></td></tr>
                                            {% endif %}
                                            {% if adj.expense|default_if_none:0|add:0 != 0 %}
                                                <tr><td>Expense</td><td class="text-end">{{ adj.expense|floatformat:2|intcomma }}</td></tr>
                                            {% endif %}
                                        {% endwith %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <!-- SEVERANCE PAY SECTION -->
                        {% if month.severance.gross %}
                        <div class="mb-2">
                            <h5 class="text-purple border-bottom pb-2 mb-3">Severance Pay</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-purple">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if month.severance.taxable_gross %}<tr><td>Taxable Gross</td><td class="text-end">{{ month.severance.taxable_gross|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        <tr class="table-primary"><td><strong>Gross Pay</strong></td><td class="text-end"><strong>{{ month.severance.gross|floatformat:2|intcomma }}</strong></td></tr>
                                        {% if month.severance.employment_income_tax %}<tr><td>Employment Income Tax</td><td class="text-end">{{ month.severance.employment_income_tax|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.severance.total_severance_deduction %}<tr><td>Total Severance Deduction</td><td class="text-end">{{ month.severance.total_severance_deduction|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        <tr class="table-success"><td><strong>Net Pay</strong></td><td class="text-end"><strong>{{ month.severance.net|floatformat:2|intcomma }}</strong></td></tr>
                                        {% if month.severance.expense %}<tr><td>Expense</td><td class="text-end">{{ month.severance.expense|floatformat:2|intcomma }}</td></tr>{% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- RIGHT COLUMN (Total Summary) -->
                    <div class="col-md-4">
                        <div class="sticky-top" style="top: 20px;">
                            <h5 class="text-primary border-bottom pb-2 mb-3">Total Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Component</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if month.totals.taxable_gross %}<tr class="table-info"><td>Taxable Gross</td><td class="text-end">{{ month.totals.taxable_gross|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.non_taxable_gross %}<tr class="table-info"><td>Non-Taxable Gross</td><td class="text-end">{{ month.totals.non_taxable_gross|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.gross %}<tr class="table-info"><td>Total Gross</td><td class="text-end">{{ month.totals.gross|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.pensionable %}<tr class="table-warning"><td>Pensionable</td><td class="text-end">{{ month.totals.pensionable|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.employee_pension %}<tr class="table-warning"><td>Employee Pension</td><td class="text-end">{{ month.totals.employee_pension|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.employer_pension %}<tr class="table-warning"><td>Employer Pension</td><td class="text-end">{{ month.totals.employer_pension|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.total_pension %}<tr class="table-warning"><td>Total Pension</td><td class="text-end">{{ month.totals.total_pension|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.employment_income_tax %}<tr><td>Employment Income Tax</td><td class="text-end">{{ month.totals.employment_income_tax|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.total_deduction %}<tr><td>Total Deduction</td><td class="text-end">{{ month.totals.total_deduction|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.final_net_pay %}<tr class="table-success fw-bold"><td>Final Net Pay</td><td class="text-end">{{ month.totals.final_net_pay|floatformat:2|intcomma }}</td></tr>{% endif %}
                                        {% if month.totals.expense %}<tr><td>Expense</td><td class="text-end">{{ month.totals.expense|floatformat:2|intcomma }}</td></tr>{% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Print Button -->
                <div class="text-center mt-4 no-print">
                    <button class="btn btn-success"
                            onclick="printCombinedDetail('combined_monthly_detail_{{ forloop.counter }}')">
                        Save or Print
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-center text-danger">No payroll data found.</p>
    {% endif %}

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-4">
        {% include "pagination.html" %}
    </div>
</div>

<style>
    .table-purple {
        background-color: #7030A0;
        color: white;
    }
    .text-purple {
        color: #7030A0;
    }
</style>

{% endblock %}